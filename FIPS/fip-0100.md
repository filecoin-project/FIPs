---
fip: "0100"
title: Removing Batch Balancer, Replacing It With a Per-sector Fee and Removing Gas-limited Constraints
author: irene (@irenegia), AX (@AxCortesCubero), rvagg (@rvagg), molly (@momack2), kiran (@kkarrancsu)
Discussions-to: https://github.com/filecoin-project/FIPs/discussions/1092 and https://github.com/filecoin-project/FIPs/discussions/1105
status: Last Call
type: Technical
category: Core
Created: 2025-02-04
---

# FIP-0100: Removing Batch Balancer, Replacing It With a Per-sector Fee and Removing Gas-limited Constraints

## Simple Summary

This FIP proposes to:

 - Remove the batch fee from all PreCommit and ProveCommit methods to incentivize sector batching during the PreCommit step and proof aggregation during the ProveCommit step;
 - Introduce a per sector fee to replace the batch balancer cost structure with a more stable mechanism that supports the long-term economic sustainability of the Filecoin network;
 - Remove protocol constraints that are no longer necessary since the introduction of proper gas accounting.

## Abstract

This FIP consists of three changes:

 - First, a straightforward way to reduce gas consumption is through sector batching and proof aggregation. Storage providers (SPs) should be incentivized to batch sectors at PreCommit and aggregate proofs at prove commit as much as possible. Currently, the efficiency of these processes is governed by the batch balancer mechanism, which is tied to the base fee and comes with several limitations. This FIP proposes the removal of the batch balancer (see details below) to enable full adoption of batching and aggregation, thereby enhancing scalability and onboarding growth.
 - Secondly, the batch balancer was introduced to address a misalignment in the Filecoin economy. Beyond blockchain execution, the Filecoin network provides SPs with a storage-auditing service through on-chain verification of proofs. While gas fees primarily account for execution costs, there is no dedicated system that properly captures the network’s storage-auditing value. The batch balancer partially addressed this gap, although attempted to achieve value capture through the gas mechanism which is primarily a means of constraining chain validation costs. With the removal of the batch balancer, a replacement mechanism is needed. This FIP proposes a better, more effective system to achieve that goal (see details below).
 - Finally, this FIP also includes the removal of gas-limited protocol constraints which are no longer needed. However, these modifications are not the primary focus of the proposal. Eliminating these constraints aims to simplify the protocol, and remove any unintentional network growth constraints.


## Change Motivation

### PreCommit batch fee removed

Due to the batch fee, currently PreCommit batching is only rational (ie, cost-effective) when the base fee exceeds 0.09 nanoFIL. Removing this fee will eliminate this obstacle, enabling more batching and therefore gas saving.

To have a rough estimate of the saving, we can compare two PreCommitSector messages posted by the same miner actor with little difference in the number of sectors when the message landed.

- [Msg 1](https://www.filutils.com/en/message/bafy2bzacebzacw3b7ymcwukk2uimahiebpke65utbfn3srgslzj5w3hh234x6): PreCommiSectorBatch2 for 1 sector : 16.7 M gas used
- [Msg 2](https://www.filutils.com/en/message/bafy2bzacebdqgivdbxzj25exae55j7vjasos45lvj4bzi6fj5oaya4rqwxrf6): PreCommitSectorBatch2 for 4 sectors): 18.6 M/ 4 = 4.6 M per sector (3.6x smaller)

### ProveCommit batch fee removed

There are two options for `ProveCommitSectors3`: (1) "simple" batching as in PreCommit (ie, one message for ≥ 2 sectors) where there is a PoRep proof for each sector in the batched message, and (2) aggregating proofs of multiple sectors and post in one message.

Batching for ProveCommit is already rational, as the batch fee applies only to aggregated proofs (opposed to PreCommit, where the batch balancer applies to batching).
On the other hand, aggregation is rational only when the base fee exceeds 0.065 nanoFIL due to the batch fee applied to aggregation. Removing this fee too will eliminate this obstacle, enabling more proof aggregation and therefore gas saving.

To have a rough estimate of the saving, we can compare these `ProveCommitSectors3` messages posted by the same miner actor with little difference in the number of sectors when the message landed[^*].

- [Msg 1](https://www.filutils.com/en/message/bafy2bzacebshpv7afwnxph6l4jnbpwpqnss3cboyfvlualfrjbox76hojjnlo): ProveCommitSectors3 for 1 sector: 267.5 M
- [Msg 2](https://www.filutils.com/en/message/bafy2bzacebd7ftq5lk4ikuif4j3xfwiabmla5bek3kuhn3k6x3obufxyzrs6y): ProveCommitSectors3 for 4 sectors, batched (no aggregation): 580 M/4 = 145 M per sector (1.85x smaller)
- [Msg 3](https://www.filutils.com/en/message/bafy2bzacedezi6lm4warrfq2n6dxvpokowzt5isacbq2kojkz462yfpfq7lxm): ProveCommitSectors3 for 4 sectors, aggregated: 517.4 M/4 = 129.3 M per sector (2x smaller).

The same logic applies to `ProveCommitSectorsNI`, where we have the same two options as in `ProveCommitSectors3`.

[^*]: A bug is currently causing single proofs (`VerifySeal`) to be charged an incorrect amount of gas units. So we added the missing units (42M per proof) to msg1 and msg2 in order to provide the future correct estimates (the bug is planned to be fixed in nv25). See [here](https://github.com/filecoin-project/FIPs/blob/master/FIPS/fip-0076.md)

### Per-sector fee added

The batch balancer mechanism had several goals and effects. Among them, two key aspects were: (1) Creating a linear cost for onboarding storage in the presence of batching/aggregation and (2) Burning tokens to balance new token supply with network burn, ensuring value distribution among FIL holders and earners.

We propose a replacement mechanism that preserves these effects while adhering to the following design principles:

 - Simplify the system to improve predictability.
 - Preserve and align network value accrual.
 - Avoid additional gas-related onboarding rate limits.
 - Enable future optimizations in the network’s execution layer.

**Proposal Details**: We introduce a per-sector fee, whose value is proportional to a fixed fraction of the circulating supply, to the sector duration and to the sector QAP (Quality Adjusted Power). To prevent this fee from becoming a significant upfront cost that could hinder onboarding, we propose daily payments instead of an upfront fee. Moreover, as a safety measure for the high-growth scenarios, we propose capping the daily payment for each sector at a fixed percentage of the daily expected block reward for that sector.

More in details, for any sector onboarded after this FIP is deployed we have:

- At ProveCommit time, we compute the per sector value as `dailyFee = k * CS(t) * sectorQAP`, where `k = 2.1536 E-25` is a system constant,  `CS(t)` is the circulating supply value at the sector activation epoch, and `sectorQAP` is the quality adjusted power of the sector in bytes. The `dailyFee` value is stored but no payment is due at ProveCommit time.
- Then, at the end of each deadline, we compute: `dailyPayment = min (deadline_dailyFee, m * expected_day_reward)`, where `deadline_dailyFee` is the sum of `dailyFee` of all sectors in the deadline, `m = 0.5` is another system constant and `expected_day_reward` is the updated value for the daily expected block reward for all sectors in the deadline. The `dailyPayment` value is burnt. Note that only new[^1] sectors and old sectors extended or updated after this FIP is deployed count for the `deadline_dailyFee` (indeed, any other sector has no `dailyFee` defined), while all sectors count for the `expected_day_reward` value.
- If a sector is extended (via the method `ExtendSectorExpiration` or `ExtendSectorExpiration2`) or updated (via the method `ProveReplicaUpdates` or `ProveReplicaUpdates3`, "snaps"), the `dailyFee` value is updated using the new `sectorQAP`, but the update is independent of the current CS value. That is: `new_dailyFee = old_dailyFee * new_sectorQAP/old_sectorQAP`.
- When the sector expires or gets terminated, the sector is no longer counted in the `deadline_dailyFee` value for the deadline.

Moreover, for any old sector:

- If the sector is extended (via the method `ExtendSectorExpiration` or `ExtendSectorExpiration2`) or updated (via the method `ProveReplicaUpdates` or `ProveReplicaUpdates3`, "snaps"), then this sector will start to pay the fee in the same way we described for the new sectors. In this case, the value `dailyFee` is computed at extension or replica update time using the CS value of that epoch.

[^1]: We use "old sectors" for sectors onboarded before this FIP is deployed, and we use "new sectors" for sectors onboarded after this FIP is deployed.

### Gas-limited constraints

Various protocol constraints that were previously necessary when there was no gas applied on actor computation are no longer necessary since the introduction of proper gas accounting with FVM (see [FIP-0032](./fip-0032.md)). This FIP proposes to remove the following constraints as they are no longer necessary in practice due to the gas mechanism being the primary constraint for computation:

* `PRE_COMMIT_SECTOR_BATCH_MAX_SIZE`: The maximum number of sector PreCommitments in a single batch.
* `PROVE_REPLICA_UPDATES_MAX_SIZE`: The maximum number of sector replica updates in a single batch.
* `DECLARATIONS_MAX`: Maximum number of unique "declarations" in batch operations (i.e. terminations, faults, recoveries).

In most cases, users will be limited by the gas limit rather than these constraints ([`message execution failed: exit SysErrOutOfGas`](https://github.com/filecoin-project/lotus/issues/10612)). Removing these constraints will simplify the protocol and remove any unintentional network growth constraints.

## Specification

This FIP makes three main changes to the protocol:

1. Removes the batch balancer fee mechanism from sector PreCommit and ProveCommit operations
2. Removes certain gas-limited protocol constraints that are no longer necessary
3. Introduces a new per-sector daily fee mechanism based on circulating supply and block rewards

### Removal of gas-limited constraints

The following constants and their use will be removed from the storage miner actor:
  - `PRE_COMMIT_SECTOR_BATCH_MAX_SIZE` - used by `PreCommitSectorBatch2`
  - `PROVE_REPLICA_UPDATES_MAX_SIZE` - used by both `ProveReplicaUpdates` and `ProveReplicaUpdates3`
  - `DECLARATIONS_MAX` - used by `TerminateSectors`, `DeclareFaults` and `DeclareFaultsRecovered`

### Removal of aggregate fee

Aggregate fee functionality and constants will be removed from the storage miner actor. This includes the following changes:
  - Remove the burning of `aggregate_fee` from `PreCommitSectorBatch2`.
  - Remove the burning of `aggregate_fee` from `ProveCommitAggregate`, `ProveCommitSectorsNI`, `ProveCommitSectors3`
  - Removal of `aggregate_fee` calculation methods and associated constants, including `ESTIMATED_SINGLE_PROVE_COMMIT_GAS_USAGE` and `ESTIMATED_SINGLE_PRE_COMMIT_GAS_USAGE`

### Fee implementation

The per-sector fee is calculated as a fixed fraction of the current circulating supply per byte of quality-adjusted power. This FIP targets a multiplier of `7.4e-15` for circulating supply per 32 GiB of quality-adjusted power. We obtain a per-byte multiplier from this as `7.4e-15 / 32 GiB ≈ 2.1536e-25` (i.e. rounded down slightly, for simplicity and a more direct multiplication). This value can then be multiplied by the sector's quality-adjusted power and the current circulating supply to derive the daily fee for a sector.

The following constants are introduced to calculate the daily fee:

```rust
/// Fraction of circulating supply per byte of quality adjusted power that will
/// be used to calculate the daily fee for new sectors.
/// Due to the large numbers involved, we'll split this into two operations.
/// The target multiplier is 2.1536e-25, which is ≈ 7.4e-15 / 32 GiB as specified
/// by FIP-0100.
/// Total scaling is 10^29 (SCALE_1 * SCALE_2) to stay within i64 bounds.
const DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_NUM: i64 = 21536;
const DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_SCALE_1: i64 = 1_000_000_000_000_000; // 10^15
const DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_SCALE_2: i64 = 100_000_000_000_000; // 10^14
```

Daily fee for an amount of quality-adjusted power and a given circulating supply may be calculated as follows:

```rust
pub fn daily_proof_fee(circulating_supply: &TokenAmount, qa_power: &StoragePower) -> TokenAmount {
    const PRECISION_BITS: u32 = 128; // Use 128 bits of precision for calculations
    let scale = BigInt::from(1).shl(PRECISION_BITS);
    let num = BigInt::from(DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_NUM);
    let denom = BigInt::from(DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_SCALE_1)
        * BigInt::from(DAILY_FEE_CIRCULATING_SUPPLY_QAP_MULTIPLIER_SCALE_2);

    let power_multiplier = (num * &scale * qa_power) / denom;
    TokenAmount::from_atto(power_multiplier * circulating_supply.atto() / scale)
}
```

A daily fee value is calculated per-sector at time of onboarding and whenever a sector's power is adjusted. For new sectors and pre-FIP-0100 sectors being updated, the daily fee calculation uses the circulating supply value at that epoch. For updated sectors (replica updates and extensions), the daily fee is adjusted proportional to the QAP change. For pre-FIP-0100 sectors that are updated for the first time after the activation of FIP-0100, the daily fee is calculated using the circulating supply value at the time of the update.

The fee value is stored as `daily_fee` in the `SectorOnChainInfo` and an aggregated `daily_fee` value is also stored in each `Deadline`. The fee is deducted from the miner actor's unvested rewards using the _fee debt_ mechanism, which is handled by cron at the end of each deadline.

Processing of the fee follows the same mechanism as fault fees, whereby the fee is paid first from locked future block rewards and then from the miner balance if there are not enough funds in the reward vesting schedule. Using the fault fee mechanism requires adding a `Deadline`'s total `daily_fee` value to the miner's `fee_debt` field, along with any additional penalties that may be due. An attempt is immediately made to repay this debt from the miner's future vesting rewards by reaching forward into the next epoch(s) that contain still-to-be-vested rewards and deducting the fee from those rewards. If there are not enough future rewards to cover the fee, the miner's balance is debited for the remaining amount. If there are not enough funds in the miner's balance to cover the fee, the miner is considered to be in debt and the fee is not paid.

Upon sector termination, the `daily_fee` recorded in the sector's `Deadline` is adjusted to remove the sector's fee.

Circulating supply is obtained from the existing `total_fil_circ_supply` system call which is also used for the Initial Pledge (IP) calculation. Upon payment, the estimated block reward for a whole `Deadline`s quality adjusted live power (which includes active, faulty and unproven sectors) is calculated and used to apply a maximum cap, as per the formula above. Efficient application of the cap will require also adding a new `live_power` field to the `Deadline` as a sum of all the power its partitions.

Note that because `live_power` is a sum of all deadline power and will include pre-FIP-0100 sectors without a `daily_fee` as well as new and updated sectors with a `daily_fee`, the cap will account for all sectors in the deadline, while the fee that is being capped will only be for the new and updated sectors, deriving a higher cap in the early period of activation of this FIP than would be expected once all sectors in the system have a `daily_fee` value.

Fee deduction will be handled in the existing `handle_proving_deadline()` function which is called from cron. As cron calls already supply current epoch rewards and current total network power, additional calls to the reward and power actors will not be necessary to calculate the cap 24h block reward fee cap.

The `Deadline` struct will be extended with `live_power` and `daily_fee` fields:

```rust
pub struct Deadline {
  // existing fields ...

  /// Memoized sum of all non-terminated power in partitions, including active, faulty, and
  /// unproven. Used to cap the daily fee as a proportion of expected block reward.
  pub live_power: PowerPair,

  /// Memoized sum of daily fee payable to the network for the active sectors
  /// in this deadline.
  pub daily_fee: TokenAmount,
}
```

The `SectorOnChainInfo` struct will be extended to include a new `daily_fee` field which will be used to store the daily fee for the sector. This value will be set at the time of sector activation, extension, and any adjustments to a sector's quality adjusted power. This field will be used to calculate the total value across all sectors in a `Deadline` so they can be charged as a group. `daily_fee` will be zero for sectors onboarded prior to activation of this FIP.

At the time of this proposal, there are approximately 650M sectors on chain. The expense of migrating and additional bytes used to store zero values for old sectors is not insignificant. Therefore it is proposed to perform a _lazy migration_ where existing `SectorOnChainInfo` objects are left alone and this new field is only added to new sectors, and sectors which are updated (for any reason). This means that reading `SectorOnChainInfo` blocks from state will support two forms: a 15 field version (old) and a 16 field version (new `daily_fee` field). The old version will instantiate with a zero value for `daily_fee` and this field will be written whenever a `SectorOnChainInfo` object is written to state, regardless of whether it contains a zero or non-zero value. i.e. reads will support 15 or 16 fields, writes will always write 16 fields.

A future migration may be proposed to unify the format, or introduce an explicit schema versioning mechanism, however this will likely be deferred until additional sector clean-up activities can take place to reduce the number of unused sectors on chain, thereby reducing the cost of migration.

```rust
pub struct SectorOnChainInfo {
  // existing fields ...

  /// The total fee payable per day for this sector. The value of this field is set at the time of
  /// sector activation, extension and whenever a sector's QAP is changed. This fee is payable for
  /// the lifetime of the sector and is aggregated in the deadline's `daily_fee` field.
  ///
  /// This field is not included in the serialised form of the struct prior to the activation of
  /// FIP-0100, and is added as the 16th element of the array after that point only for new sectors
  /// or sectors that are updated after that point. For old sectors, the value of this field will
  /// always be zero.
  #[serde(default)]
  pub daily_fee: TokenAmount,
}
```

Multiple queues are used to maintain the correct state of partitions and deadlines as sectors pass through various phases of their lifecycles. `ExpirationSet` is a fundamental type used in these queues which are indexed by epoch and track early and on-time expiration of sectors, their resultant total pledge and power adjustments. To maintain efficiency during the mutation of the partitions within each deadline, the `ExpirationSet` struct will be extended to add `fee_deduction` which will track the total delta in daily fee for each sector that is added or removed from the set.

Similar to `SectorOnChainInfo`, a _lazy migration_ strategy will be employed for `ExpirationSet` objects. The `fee_deduction` field will be added to the struct but will only be _implicitly_ zero for all existing `ExpirationSet` objects. That is, it will not be present in the serialised form of any `ExpirationSet` objects written prior to the activation of FIP-0100. The field will be written to state whenever an `ExpirationSet` object is written to state after the activation of FIP-0100, regardless of whether it contains a zero or non-zero value. This will create two serialized forms of `ExpirationSet` in the state: one with 5 fields (old) and one with 6 fields (new `fee_deduction` field).

```rust
pub struct ExpirationSet {
    /// Adjustment to the daily fee recorded for the deadline associated with this expiration set
    /// to account for expiring sectors.
    ///
    /// This field is not included in the serialised form of the struct prior to the activation of
    /// FIP-0100, and is added as the 6th element of the array after that point only for new objects
    /// or objects that are updated after that point. For old objects, the value of this field will
    /// always be zero.
    #[serde(default)]
    pub fee_deduction: TokenAmount,
}
```

**Sector commitments**: At each of `ProveCommitSectors3`, `ProveCommitAggregate` and `ProveCommitSectorsNI`:

  * The `daily_fee` for each sector is calculated based on the circulating supply at that epoch and the quality-adjusted power of the sector and recorded in the new `SectorOnChainInfo` object for the sector.
  * As sectors are assigned to deadlines, the existing `daily_fee` total recorded in that `Deadline` is updated to include the new sector's `daily_fee`.
  * As sectors are further assigned to partitions within the deadline and their expiration recorded in the partition's expiration queue, the `fee_deduction` in the `ExpirationSet` for the epoch is updated (or set) to include the new sector's `daily_fee`.

**Replica updates** (snaps): `ProveReplicaUpdates` and `ProveReplicaUpdates3` may result in a change of a sector's quality-adjusted power. Such a change will require updating the sector's `daily_fee` value but still using the circulating supply value at the time the sector was onboarded. Therefore the new `daily_fee` value is changed in proportion to the change in the sector's quality-adjusted power (i.e. `daily_fee *= new_QAP / old_QAP`).

Sectors that were onboarded prior to the activation of this FIP, and therefore do not have a `daily_fee` value, will be updated during a replica update operation to have the `daily_fee` field and its value will be calculated according to the circulating supply at the time of the update and the new quality-adjusted power of the sector.

The `daily_fee` total in the sector's `Deadline` will also need to be updated to reflect the change in the sector's `daily_fee` and the `fee_deduction` in the `ExpirationSet` for the sector's expiry epoch will also need to be updated.

**Sector extensions**: Extensions don't change a sector's quality-adjusted power, only the duration of the sector so in normal operation will not impact a sector or its deadline's `daily_fee` value.

Sectors that were onboarded prior to the activation of this FIP, and therefore do not have a `daily_fee` value, will be updated when their lifetime is extended to have the `daily_fee` field and its value will be calculated according to the circulating supply at the time of extension and the quality-adjusted power of the sector (i.e. extending an old sector that does not previously attract a daily fee will cause it to attract a daily fee). This will also require updating the sector's `Deadline` total `daily_fee` value and the `fee_deduction` value in the `ExpirationSet` for the sector's expiry epoch. Sectors with an existing `daily_fee` will not need to be updated, the existing value will be used for the extended duration.

**Faults**: There is no impact on a sector or deadline's `daily_fee` value. However, faults can cause changes to a partition's expiration queue to ensure proper handling of a faulty sector's lifecycle. Changes in `ExpirationSet` to move sectors between queues will also include corresponding changes to `fee_deduction` values.

**Early terminations**: both automatic and manual, will result in a reduction of a `Deadline`'s `daily_fee` value for the sectors being terminated.

| Change State | Sector's `daily_fee` | Deadline's `daily_fee` | ExpirationSet's `fee_deduction` | Additional Notes |
|-------------|---------------------|------------------------|--------------------------------|-----------------|
| **Sector commitments** | Calculate based on current circulating supply and QAP, store in `SectorOnChainInfo` | Increase by new sector's `daily_fee` | Update for the sector's expiry epoch | Applied during `ProveCommitSectors3`, `ProveCommitAggregate` and `ProveCommitSectorsNI` |
| **Replica updates** | For existing sectors: adjust proportionally to QAP change<br>For pre-FIP sectors: calculate new using current circulating supply | Update to reflect sector's new `daily_fee` | Update for the sector's expiry epoch | Applied during `ProveReplicaUpdates` and `ProveReplicaUpdates3` |
| **Sector extensions** | For existing sectors: no change<br>For pre-FIP sectors: calculate new using current circulating supply | Update as needed for pre-FIP sectors | Update for both old and new expiry epochs | Applied during `ExtendSectorExpiration` and `ExtendSectorExpiration2` |
| **Faults** | No change | No change | Update if sectors move between queues | No direct impact on fee calculation |
| **Early terminations** | N/A (sector removed) | Reduce by terminated sector's `daily_fee` | N/A (sector removed) | Applies to both automatic and manual terminations |

### Migration

At activation of this FIP, a new schema for the `Deadline` block type will be introduced, adding two new fields: `live_power: PowerPair` and `daily_fee: TokenAmount`. A migration will be performed on all deadlines, across all miner actors. As the majority of deadlines referenced on chain are _the_ empty `Deadline` block, a CID for this singleton block may be used to speed up migration where the CID for the previous form's `Deadline` block is encountered. All `daily_fee` values will be set to zero at migration and the `live_power` will be calculated as a sum of the `live_power` in each of the `Partition`s assigned to the `Deadline`.

No migration is necessary for `SectorOnChainInfo` or `ExpirationSet` as the lazy migration strategy is employed.

### Special handling for Calibration network

In order to properly test the implementation of this FIP, a long-standing problem with circulating supply calculation on Calibnet will need to be addressed. Circulating supply is calculated using an estimation method each epoch and supplied to the FVM, it uses these inputs (from the time of writing):

| Metric               | Mainnet (FIL) | Calibnet (FIL) |
|----------------------|--------------:|---------------:|
| `FilVested`          |   484,847,134 |    323,483,605 |
| `FilMined`           |   365,928,138 |     68,672,646 |
| `FilBurnt`           |    40,327,377 |     32,117,860 |
| `FilLocked`          |   140,975,297 |      3,893,484 |
| `InitialFilReserved` |   300,000,000 |    300,000,000 |
| `FilReserveBalance`  |   282,933,381 |    869,278,271 |

The amount of reserved funds disbursed from f090 (`FilReserveDisbursed`) is then calculated as:

```math
FilReserveDisbursed = InitialFilReserved - FilReserveBalance
```

For Mainnet:
```math
FilReserveDisbursed = 300,000,000 - 282,933,381 = 17,066,619
```

For Calibnet:
```math
FilReserveDisbursed = 300,000,000 - 869,278,271 = -569,278,271
```

Circulating supply (`CS`) is then calculated as:

```math
CS = \max(0, FilVested + FilMined + FilReserveDisbursed - FilBurnt - FilLocked)
```

For Mainnet:
```math
CS = \max(0, 484,847,134 + 365,928,138 + 17,066,619 - 40,327,377 - 140,975,297) = 686,539,216
```

For Calibnet:
```math
CS = \max(0, 323,483,605 + 68,672,646 + (-569,278,271) - 32,117,860 - 3,893,484) = 0
```

Calibnet currently executes with a circulating supply of `0` each epoch, regardless of token movements.

Because this FIP uses a fixed portion of current circulating supply to calculate the fee, Calibnet fees will always be `0`, which makes proper testing of the new functionality in live network conditions impossible.

To address this problem, this FIP will also adjust network parameters for Calibnet to ensure that the circulating supply is a reasonable and dynamic positive number. The core problem is the initial allocation of reserve funds which appears to have been set to 900M FIL. This was likely set to ensure a total supply of 2B FIL. Unfortunately, implementations use the same `InitialFilReserved` value as mainnet, 300M FIL.

Filecoin node implementations compatible with Calibnet will be required to set their `InitialFilReserved` for Calibnet (only) to `900,000,000` FIL **from the activation epoch of this FIP** (i.e. a value of `300,000,000` FIL must be used for epochs up until then, including when re-executing older tipsets). This will result in a more appropriate circulating supply calculation starting from the activation epoch of this FIP:

| Metric                | Mainnet (FIL) | Calibnet (FIL) |
|-----------------------|--------------:|---------------:|
| `InitialFilReserved`  |   300,000,000 |   900,000,000  |
| `FilReserveDisbursed` |    17,066,619 |    30,721,729  |
| `FilCirculating`      |   686,539,216 |   386,866,636  |

## Design Rationale

We aimed for a design that is simple to understand and model, and relatively simple to implement. With this in mind, we explored the following fee structures:

- **Upfront Payment vs. Ongoing Payment**: The first offers better predictability, while the second reduces the risk of creating an entry barrier and a disincentive for sectors with longer durations. With this FIP, we chose a hybrid approach that captures the benefits of both by computing the fee value upfront for predictability, but allowing it to be paid daily over sector lifetime instead of as a lump sum upfront. Moreover, the daily payment option allows us to easily implement a security measure by capping the daily value at a fixed fraction of the per-sector block reward. See [here](https://github.com/filecoin-project/FIPs/discussions/1105#discussioncomment-12195305) for more details.

- **Flat Fee vs. Dynamic Fee**: A fixed per-sector fee provides predictability and consistency, while a fluctuating fee based on network congestion, onboarding rate, or other variables better captures value when the network is actively providing a service. We chose a model where the fee is a fixed fraction of a quantity that adjusts to economic conditions. We evaluated the following economic indicators for determining the per-sector fee: Initial Pledge (IP), per-sector Block Reward (BR) and Circulating Supply (CS).
  - The IP-based fee was discarded to avoid complex system dependencies, as changes to IP in future FIPs could unintentionally impact the per-sector fee.
  - The BR-based fee was discarded because the fee-to-reward ratio did not adjust properly to network growth, leading to high fees even when onboarding demand was low. See [here](../resources/fip-0100/fip0100Appendix.md) for more details.
  - CS was ultimately chosen because it normalizes fees relative to the Filecoin economy, ensuring both adaptability and predictability.

We reached this conclusion through simulation-based analysis, modeling the impact of fees under different network conditions. Specifically, we evaluated multiple input trajectories: 0.5×, 0.75×, 1×, and 2× the current onboarding, renewal, and FIL+ rates. Since both renewals and FIL+ are near 100%, we capped them at their current maximum (see Fig. 1).
<div align="center">
  <img src="https://github.com/user-attachments/assets/e4ac2327-e1bf-4512-8f7c-cee45a45218b" width="650">
  <p><em>Fig 1: Network state evolution for each input trajectory.
</em></p>
</div>

For each trajectory, we analyzed the expected fee and related metrics over time. Fig. 2 presents these results for the CS-based fee, incorporating a cap at 50% of `expected_day_reward` as a safety measure in high-growth scenarios[^2]. See [here](../resources/fip-0100/fip0100Appendix.md) for more details. Notably, Fig. 2 confirms that the CS-based fee proposed in this FIP offers the following key advantages:
- **Stable Economic Reference**: A fixed percentage of CS functions like a fixed USD fee if market cap remains stable, keeping costs predictable;
- **Adapts to Market Conditions**: If Filecoin’s valuation rises, fees increase in FIL terms, scaling with the economy. If the market stagnates, fees stay economically consistent.
<div align="center">
    <img src="https://github.com/user-attachments/assets/018fb429-de90-4a86-9c15-6c244a699487">
    <p><em>Figure 2: CS-based fee evolution as a function of various network metrics. Here we considered a daily payment that is a fixed % of CS-based and capped at 50% of `expected_day_reward` as a safety measure in high-growth scenarios. The Fee/Sector values assume 32GiB of QAP.
</em></p>
</div>

[^2]: The simulation applies the cap at the sector level, while implementation applies the cap at the partition level as explained in the Spec section.

## Backwards Compatibility
This FIP modifies actor behavior and will require a new Filecoin network version.

## Test Cases

### builtin-actors

Many of the test scenarios outlined below already exist within the test suite for builtin-actors. Ensuring that all of the various cases, particularly edge-cases, are covered will be important to ensure that the new fee mechanism is correctly implemented and behaves as expected. In addition, any existing test scenarios that test sector lifecycles should be updated to include invariants that check the new fee mechanism: that it is correctly calculated, tallied in the partition, remains correct over time, is correctly deducted in `handle_proving_deadline()`, is correctly capped and is correctly adjusted for terminations.

* Test that the batch balancer fee is removed from `PreCommitSectorBatch2` and `ProveCommitAggregate`, `ProveCommitSectorsNI`, `ProveCommitSectors3`
* Test that the gas-limited constraints are removed from the protocol
* Test that the per-sector fee is correctly calculated and added to the respective partition's `daily_fee` value when using `ProveCommitAggregate`, `ProveCommitSectorsNI`, `ProveCommitSectors3`
  * Tests should cover different batching variations
* Test that `ProveReplicaUpdates` and `ProveReplicaUpdates3` do not have an impact on the fee mechanism
* Test that the per-sector fee is correctly charged at the end of each deadline for all sectors in the active, faulty, and recovered states
  * Tests should cover different batching variations
* Test that manual early terminations correctly adjust the deadline's `daily_fee`
* Test that automatic early terminations correctly adjust the deadline's `daily_fee`
* Test that sector expiration correctly adjusts the deadline's `daily_fee`
* Test that the fee is correctly capped at the expected daily block reward at the time it is paid

### Calibration network

Once Calibnet is upgraded, functional tests should be performed that cover:

* Ensure that the circulating supply is a reasonable and dynamic positive number
* Onboarding new sectors with `PreCommitSectorBatch2` and `ProveCommitAggregate`, `ProveCommitSectors3` (and `ProveCommitSectorsNI` if possible) and:
  * observing that the batch balancer fee is not applied
  * observing deadline state to ensure that the new fee mechanism is correctly implemented and behaves as expected
* Observing that the per-sector fee is correctly charged at the end of each deadline for all sectors in the active, faulty, and recovered states
* Observing that manual early terminations correctly adjust the deadline's `daily_fee` value

## Security Considerations

This FIP does not affect underlying proofs or protocol security.

## Incentive Considerations

Filecoin’s network revenue model is currently tied to the gas usage, and the most amount of gas is used by storage onboarding methods. This creates an incentive misalignment, where economic considerations lead to an incentive to not optimize the gas usage of onboarding methods, as this could hurt overall network revenue.

The Batch Balancer mechanism exemplifies this concept: batching and aggregating abilities were introduced to increase gas efficiency of onboarding methods, but the batch balancer mechanism restricted use of these abilities to when the network demand was high, to protect Filecoin’s economic interests.

This FIP fixes this incentive misalignment by disconnecting the network revenue from gas usage. The removal of the batch balancer allows for aggregation to occur at any level of demand regardless of network utilization rate (such as current levels of demand). We expect this to lead to a reduction of about ~30% in per-sector onboarding gas. This would in turn result in a drop in base fee, and therefore a drop in gas-based network revenue.

The explicit per-sector fee introduced by this FIP allows us to remove the batch balancer, and support other future gas usage optimizations, without adding macroeconomic risk.

The removal of batch balancer and associated reduction in gas fees are up-front improvements to SP costs designed to unblock and support faster data onboarding. This up-front cost-reduction is balanced by the per-sector fee that is charged gradually over the sector lifetime, starting at a small fraction of daily block rewards and adjusting dynamically based on network economic growth rate.


## Product Considerations
From a product perspective, this FIP is expected to:
- Decouple gas fees (blockspace costs) from service fees (storage-auditing costs): This separation creates a more resilient system, reducing sensitivity to base fee spikes and ensuring predictable and fair costs for SPs.
- Simplify cost analysis and calculations for SPs: The network will provide a smoother user experience by clearly distinguishing between congestion control (managed via base fees) and payments for services unrelated to congestion.
- Capture value for the storage-auditing service: By introducing a per-sector fee burn, the network can proportionally capture value based on storage demand.
- Ensure economic stability amid future optimizations: Improvements in proof mechanisms or onboarding throughput will no longer risk destabilizing the network’s economic alignment. This ensures the Filecoin protocol can lower costs for SPs while still capturing value for the network.
- Remove gas-limited constraints: Eliminating these unnecessary constraints simplifies the protocol and allows gas mechanisms to serve as the primary network constraint, making the system more adaptive and flexible to changing conditions.

## Implementation

1. Remove the batch balancer fee mechanism from sector PreCommit and ProveCommit operations (TBD)
2. [Remove gas-limited protocol constraints that are no longer necessary](https://github.com/filecoin-project/builtin-actors/pull/1586)
3. Implement per-sector daily fee mechanism based on circulating supply and block rewards (TBD)
4. [Fix `VerifySeal` gas bug](https://github.com/filecoin-project/ref-fvm/pull/2103)
5. Fix circulating supply calculation on Calibnet (TBD)

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
