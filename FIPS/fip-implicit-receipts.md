---
fip: "<to be assigned>"
title: Implicit Messages in Block Receipts
author: "Rod Vagg (@rvagg)"
discussions-to: https://github.com/filecoin-project/FIPs/discussions/<number>
status: Draft
type: Technical
category: Core
created: 2025-05-14
spec-sections:
  - 2.8.18.32 Receipts
  - 2.8.21.42 Implicit messages
requires: N/A
replaces: N/A
---

# FIP-XXXX: Implicit Messages in Block Receipts

## Simple Summary

This FIP proposes adding implicit messages (cron and reward) to block receipts, allowing their execution to be inspected and events generated by system operations to be properly captured and tracked in the chain. A primary benefit of this is better visibility into sector lifecycles.

## Abstract

Currently, Filecoin's cron and reward operations execute via implicit messages inserted during the execution of a tipset. Execution of these messages produces events, but these events cannot be captured properly since execution receipts are not captured and referenced by the chain. This proposal addresses this limitation by:

1. Formalising implicit messages such that they can be linked on the chain and stored in a node's blockstore;
2. Including links to the executed message in the `MessageReceipt` object generated after execution; and
3. Including `MessageReceipt` objects for implicit messages in the `ParentMessageReceipt`s array in the BlockHeader

This change enables proper event capture for system operations, particularly improving sector lifecycle tracking, and affords the ability to more completely observe the execution of a tipset.

## Change Motivation

The existing protocol has a critical gap in event tracking for system operations. Cron and reward operations produce important events (particularly for sector lifecycle tracking), but since they use implicit messages without proper receipts, these events are lost. This forces users and tools to perform complex analysis of state diffs between epochs to understand what happened, particularly for tracking sector terminations.

Current challenges include:

1. Sector lifecycle events (especially terminations) are not easily visible through events or message receipts
2. External APIs struggle to provide comprehensive sector tracking information
3. Tooling for inspecting state changes between tipsets is unnecessarily complex and difficult to interpret
4. Important system operations lack visibility in the chain's event system

This change is necessary to provide complete visibility into chain operations and significantly simplify tracking of sector lifecycles and other system events.

## Specification

### MessageReceipt Structure Modification

The `MessageReceipt` structure will be modified to include a reference to the executed message:

```go
type MessageReceipt struct {
    version    MessageReceiptVersion
    ExitCode   exitcode.ExitCode
    Return     []byte
    GasUsed    int64
    EventsRoot *cid.Cid // Root of Event AMT with bitwidth = EventAMTBitwidth
    Message    cid.Cid  // NEW: Reference to the executed message
}
```

### Implicit Message Definitions

Implicit messages must be encoded consistently to produce stable CIDs across all Filecoin nodes. The following definitions, currently used by Filecoin's reference implementation (Lotus) will be used:

#### Reward Messages

```go
rwMsg := &types.Message{
    From:       builtin.SystemActorAddr,
    To:         reward.Address,
    Nonce:      uint64(epoch),
    Value:      types.NewInt(0),
    GasFeeCap:  types.NewInt(0),
    GasPremium: types.NewInt(0),
    GasLimit:   1 << 30,  // 1073741824
    Method:     reward.Methods.AwardBlockReward,
    Params:     ser,
}
```

#### Cron Messages

```go
cronMsg := &types.Message{
    To:         cron.Address,
    From:       builtin.SystemActorAddr,
    Nonce:      uint64(epoch),
    Value:      types.NewInt(0),
    GasFeeCap:  types.NewInt(0),
    GasPremium: types.NewInt(0),
    GasLimit:   10_000_000_000 * 10000,
    Method:     cron.Methods.EpochTick,
    Params:     nil,
}
```

### Message Execution Order

Messages will be ordered as they currently are for tipset execution, and this order will now also be used to determine the order of receipts referenced in the `ParentMessageReceipts` list:

1. Previous null round cron messages (if any null rounds immediately prior to this tipset)
2. For each block in the tipset:
   - Messages in that block (excluding duplicates already executed from previous blocks in this tipset)
   - Reward message for that block
3. Cron message for the current epoch

### Block Structure Changes

- Implicit messages will NOT be included in the `Messages` list in block headers
- Implicit messages WILL be referenced in the `ParentMessageReceipts` list which is a single (not per-block) list for the entire parent tipset, ordered by execution
- Each epoch will contain at least one cron message, plus additional cron messages for preceding null rounds

## Design Rationale

This design was chosen to minimise disruption to existing systems while providing complete visibility into system operations.

1. **Receipt linking**: Allows events to be properly associated with their originating messages rather than indirectly via the de-duplicated across-block list generated from parent blocks and allows us to insert implicit messages without needing to list them in a new block filed.
2. **Execution ordering**: Maintains consistency with current execution semantics.
3. **Message specification**: Uses the existing Lotus implicit message format as a stable basis for all node implementations.

Alternative approaches considered included:
- Creating a separate structure for system events: Rejected due to complexity and inconsistency with existing event systems and difficulty associating events with messages
- Modifying the block header structure: Rejected due to increased blast radius of change impact

## Backwards Compatibility

This change introduces several backwards incompatibilities:

1. **Receipt Structure Change**: The `MessageReceipt` structure modification requires updates to all code that directly accesses receipt fields; this change will take effect at the next epoch after the activation epoch of this FIP
2. **Message/Receipt Count Mismatch**: Code assuming `len(parent messages) == len(receipts)` will break and must be updated to use receipts as the canonical list of messages executed and filter out implicit messages as required

**Snapshot** format and contents will not change with this FIP. Existing chain snapshots do not contain receipts or events, any existing system that requires receipts from snapshot data already needs to re-execute messages, this will remain the case.

**Migration strategy**

- Activation at a specific epoch through network upgrade
- Code must be updated to handle both old and new receipt formats, before and after activation epoch
- Tooling must be updated to understand the presence of implicit messages in receipts

**Migration details**

No state migration is necessary; migration exists entirely within a node implementation external to message execution and relates to the handling of tipsets executed before and after the activation epoch and the consistent generation of block headers and their immediate child components.

- For all epochs before this change is activated, `MessageReceipt` will not contain a link to the executed message, `len(parent messages) == len(receipts)` will be true, and implicit messages and their events will not be accessible
- For all epochs after this change is activated, `MessageReceipt` will contain a link to the executed message, `len(parent messages) == len(receipts)` will not be true, and implicit messages along with their events will be accessible (a node may choose to not persist any events after execution, as is the case today)

## Test Cases

The following test cases are required:

1. Verify stable CID generation for implicit messages across implementations
2. Test correct ordering of messages in blocks with null rounds
3. Validate event capture for cron and reward operations
4. Ensure backward compatibility for pre-upgrade epochs
5. Test receipt iteration with implicit messages present
6. Verify garbage collection behavior for implicit messages
7. Verify snapshots do not contain unwanted elements (receipts, events)

## Security Considerations

This change has minimal security implications as it primarily affects event tracking and visibility. Key considerations:

1. **Consensus Safety**: The change must be activated simultaneously across all nodes to maintain consensus
2. **Resource Usage**: Slight increase in processing and storage requirements due to additional messages

The change does not introduce new attack vectors or modify existing security properties of the protocol.

## Incentive Considerations

This FIP has positive incentive implications:

1. **Storage Provider Benefits**: Improved sector lifecycle insights unlocks additional opportunities to sell and market PoRep
2. **Tool Developer Incentives**: Simplified access to system events encourages development of better monitoring and analysis tools
3. **Network Transparency**: Increased visibility into system operations improves trust and participation

Negative impacts from this change include:

1. **Network-version Based Tipset Decoding**: Given the `MessageReceipt` changes and `len(parent messages) != len(receipts)` difference, complexity is introduced in node implementations that attempt to retain compatibility across the upgrade boundary
2. **Block Storage Increase**: Including at least one reward message per block and one cron message per tipset in message receipts slightly increases the size of an active node's blockstore

## Product Considerations

This change significantly improves the developer and user experience:

1. **Enhanced Observability**: Complete visibility into sector lifecycles and system operations
2. **Simplified Tooling**: Eliminates need for complex state diff analysis
3. **Better APIs**: External services can provide more comprehensive blockchain data
4. **Improved Debugging**: System operations become traceable through standard event mechanisms

This enables development of more sophisticated storage management tools and improved monitoring solutions.

## Implementation

Implementation requires changes to:

1. Core protocol code for `MessageReceipt` structure
2. Block validation logic to handle implicit messages
3. Chain storage modules to persist implicit messages
4. API methods that interact with messages and receipts
5. Testing infrastructure to validate the changes

* Lotus PR (TODO)
* Forest PR (TODO)

## Open Questions

Non-consensus-critical questions that are not yet answered by this FIP but may be considered during or after implementation:

* Impact on existing Filecoin (Common Node API and additional Lotus or Forest) APIs: are implicit messages always excluded from message-fetching APIs such as `ChainGetMessagesInTipset`?
* Impact on Ethereum-compatible APIs such as: `EthGetBlockTransactionCountBy*`, `EthGetTransaction*`, `EthGetBlockReceipts`, etc. are they either exposed explicitly or available implicitly via any of these APIs?

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).