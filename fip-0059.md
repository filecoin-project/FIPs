| fip | title | author | discussion-to | status | type | category | created |
| --- | --- | --- | --- | --- | --- | --- | --- |
| fip0059 | Synthetic PoRep | @Kubuxu  @Luca  @Rosario Gennaro @Nicola @Irene   | https://github.com/filecoin-project/FIPs/discussions/245 and https://github.com/filecoin-project/FIPs/discussions/603 | draft | technical | core | 10 Feb 2023 |
## Simple Summary

This proposal presents a new PoRep protocol (Synthetic PoRep) that reduces the size of the temporary data stored between PreCommit and ProveCommit (150 epochs) from ~400GiB to ~25GiB, with no impact on security.

## Abstract

Synthetic PoRep achieves reduction in used up space by reducing the set of challenges that might be chosen during the interactive Commit step.  With Synthetic PoRep, the scope of potential challenges is reduced to a predefined number which can be precomputed. 

- A Storage Provider can complete the challenge generation and vanilla proof computation before performing PreCommit on-chain, thus removing layers data before the sector is pre-committed on-chain;
- The GPU cost for SNARK generation during Commit is not significantly increased.

![127000041-08dfc38d-65f8-43f6-9c7f-06416ff0e5e9](https://user-images.githubusercontent.com/23217773/218122043-a2700204-1f60-4f76-81d2-0d6c5d024900.png)


## Motivation

The current interactive PoRep protocol (PreCommit + ProveCommit) requires a user to seal and keep a buffer of 12 layers (11 SDR layers + 1 data layer) between PreCommit and ProveCommit. The purpose of this FIP is to reduce this compute cost without sacrificing network security. 

## Specification

Differences between currently deployed PoRep and Synthetic PoRep are limited to challenge generation and additional capabilities for the Storage Provider.

1. **Starting point**
    1. We assume there is a sector S for which the Storage Provider completed PreCommit1 and PreCommit2 computations.
    2. This sector is not listed on-chain.
    3. The Storage Provider possesses knowledge of CommR and CommD of that sector (acquired in PreCommit2 step) and the layers needed to generate CommR
2. **Storage Provider generates “Synthetic” challenges from CommR**
    1. Based on CommR, the Storage Provider generates a list of `SynthChallengesNumber` challenges
    2. The Storage Provider computes responses for all the `SynthChallengesNumber` challenges, which take the form of `SynthChallengesNumber` vanilla proofs and saves them for future use.
3. **Storage Provider can remove layers data**
    1. As the Storage Provider knows responses to all possible challenges that will be asked in the interactive step, they can remove the layers data which is needed to respond to challenges.
4. **Storage Provider publishes “PreCommitsSector”**
    1. Using the same flow as today, Storage Provider submits the sector for PreCommit.
    2. This establishes when the randomness for interactive response will be known (`PreCommitChallengeDelay`)
5. **Storage Provider generates and publishes ProveCommitSectors proof**
    1. Storage Provider waits `PreCommitChallengeDelay` (~150 epochs).
    2. The randomness revealed at PreCommitEpoch+PreCommitChallengeDelay selects `VerifiedChallengesNumber` (176) challenges to be verified on-chain from the `SynthChallengesNumber` challenges generate in step 2.
    3. Storage Provider takes the `VerifiedChallengesNumber` vanilla proofs that were generated earlier corresponding to selected challenges and computes SNARK proofs of these challenges.
    4. Storage Provider publishes the ProveCommit either in individual or aggregated form.
6. **Chain verifies proof**
    1. Using interactive randomness as a seed chain generates `VerifiedChallengesNumber` challenges by selecting `VerifiedChallengesNumber` indices out of `SynthChallengesNumber` and computing them.
    2. Generated challenges are fed into proof verification.

## Rationale

Synthetic PoRep is a PoRep optimization which has basically no downside with respect to status. Indeed, it would allow for more than 90% storage cost savings between PreCommit and ProveCommit. 
Additionally, we would achieve: 

- No impact on the current on-chain flow
- No need for new Trusted Setup
- No proving overhead
- No impact on PoRep security

## Backwards Compatibility

Synthetic PoRep would become a new proof type with the same on-chain flow as current PoRep.

## Test Cases

Will be included with implementation to be presented.

## Security Considerations

In the current PoRep protocol, if more that 3.9% of nodes in a layer are wrongly encoded, then the ProveCommit step will fail with large probability (larger than 1-2^(-10)).
In the new protocol, the SP first samples a set of `SynthChallengesNumber` positions and then proceeds to sample the 176 challenges from there. In order to be able to keep the same security as before, we need that the distribution of errors in the synthetic challenge set is as close as possible to the original distribution of errors in the layer. However the adversary can try different sets to get one where the fraction of wrongly encoded nodes is smaller than 3.9%. Say for example that adversary wants a fraction of 3.49% (this will allows it to pass with probability (1-0.0349)^176 > 2^{-9} > 2^{-10}),  we can show that if N = `SynthChallengesNumber` is large enough, then this is not possible. More in details, the probability that the number of wrongly encoded in the sythetic set is ≤ 0.0349*N is given by the bynomial probabilty:

$$
P= \sum_{i=0}^{0.0349 N} \binom{N}{i}p^i (1-p)^{N-i} \text{ with } p ≥ 0.039
$$

and with N = `SynthChallengesNumber` ≥ 225000, then P < 2^{-80}. 

## Incentive Considerations

This proposal does not affect the current incentive system of the Filecoin network.

## Product Considerations

This proposal reduces the hardware usage for the PoRep and therefore represents a cost saving opportunity for Storage Providers.

## Implementations

TODO

## Copyright Waiver

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
